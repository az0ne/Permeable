进入NBArticle_200_RC2文章系统--FCKeditor的上传漏洞

进入NBArticle_200_RC2文章系统--FCKeditor的上传漏洞


 


昨天，在一个源码站浏览时，看到NB文章系统发布了NBArticle_200_RC2版，便DOWN了一套研究。

一、只读浏览器 本来是想从注入方面入手，但看过几个文件后，不由地放弃了这个想法，因为代码很是严谨，无从入手！ 那就再看一下上传方面，不过对个思路没抱任何希望。NB系统！能那么轻易就让我一个菜鸟找到破绽！ 在本地搭建了这套NB文章系统，注册了一个用户登录，然后点击“发布文章”。
 

来到“我要投稿”页面，看一看这里有没有上传的地方？在点了一个又一个的标签后，终于在“正文”的“插入/编辑图像”标签上打开了一个看似上传的窗口

点击其中的“浏览服务器”又打开一个窗口。

窗口名称为：“FCKeditor -Resources Browser”，当时以为是NB自已写的一个上传程序呢！后来才搞明白，这是洋人开发的在线编辑器，用户可以在它设定的目录内新建文件夹或上传文件，非常方便用户调用自已所上传的文件，也便于管理员的管理。点击“浏览”选择了一个cer格式的文件上

非法文件！当然不行了，要是行那才叫怪呢！后来又用“WinSock Expert”抓数据包分析，捣鼓了好长时间，也没有成功，只得做罢！ 这样的上传程序，我是第一次接触，反正也没有别的思路，顺便了解一下这个“FCKeditor”都有什么功能。点击下方的“Create New Folder”，弹出一个窗口，“Type the name of the new folder”（输入一个新文件夹名），随便输了一个“aa”，哟！在窗口内真的有了一个aa文件夹

原来用户就是这样创建自已的文件夹。这时，我忽然有了一个奇怪的想法，如果新建一个名为“../bb”的文件夹，利用Windows对“../”读取的缺陷，是不是就把“bb”文件夹创建到了aa文件夹所在目录的上一层了？试一试！点击“创建文件夹”，在输入框内输入“../bb”，点“确定”完成创建，看了一下文件目录，没有任何变化。是不是没有创建成功？还是创建到上一层目录中了？如果创建成功，那上一层目录名是什么？当前上传的图片又保存到那儿了？带着这些疑问我打开“搜索”程序，填入我刚才新建的“aa”文件夹名，路径选择NB网站目录，开始搜索。没一会，就找到了这个文件夹，在网站目录下的UserFiles\Image文件夹中，进资源管理器依次展开路径，当打开UserFiles文件夹时，我看到了bb文件夹，它和aa的上级目录Image位于同一文件夹UserFiles内，看来可以利用“../”来创建文件夹，但如何在“FCKeditor ”看到所创建的文件夹呢？ 看着“FCKeditor”窗口发一会呆，才想起这个窗口隐藏了网址，还没有了解这个上传页面的地址呢！按F11查看窗口地址，是：“http://127.0.0.1/nb2/editor/fck_editor/editor/filemanager/browser/default/browser.html?Type=Image&Connector=connectors/asp/connector.asp”
这么长啊！看了一会也有些明白了，虽然使用的是 Browser.html，但提交的语法和Asp一样，“？”后的应该是提交值，有两个，一个是Type，提交的值是Image；另一个是Connector，提交的值是Connectors/asp/connector.asp。那个Connector提交的Asp文件好像不能利用，但那个Type提交的Image却看着有些面熟，在那里？在那里见过你…… 想起来了，在上传图片的“FCKeditor”窗口左侧Resource Type选项中，就有一个Image，可能就是它！如果把Image改为bb，是不是可以看到bb文件夹中的内容？先在bb文件夹内新建了一个abcd.txt文本文件，然后将地址栏中的Image改为bb后回车。没看到Txt文件！是不是窗口最大化的原因？点还原按钮.

在其中显示出了abcd.txt文件名及文件大小，测试成功，找到了“FCKeditor”的一个缺口。“../”又在我脑中闪烁，如果把bb改为“../”，是不是就可以看到上一层目录中的内容了？在原“FCKeditor”窗口中用F11来回切换窗口，觉得太麻烦，就把网址复制下来，重新开启一个IE，粘贴到地址栏内，再将其中的bb改为../，回车，想不到还真能运行。

跳转到了NB文章系统所在的目录了。又加了一个../，回车后目录又向上跳了一级，再加../就再向上跳一级，最后一直跳到这个盘的根目录下。 测试到这里，我觉得“FCKeditor”编辑器完全可以做一个功能简单的文件只读浏览器，使用“..”/查看当前盘内所有文件夹及文件的名称和容量。假设某个网站和NB文章系统同在一个服务器的盘符内，那么使用“FCKeditor”这个只读浏览器不就可以看到某个网站数据库的名称了，比暴库还要来得直接！
二、无限上传 可惜只能上传图片格式文件，要是能上传asp、cer等格式文件该多好！这样想着，无意间选择了一个cer文件上传，竟然没有提示错误！感到很奇怪，看了一下文件目录中的内容。

那个Newmm.cer竟然传上去了！在看到文件传上去的那一刻，我激动地简直要跳了起来，想不到偶误打误撞的找到了NB文章管理系统的漏洞，这么好的手气，应该再去买组彩票！ 在经过反复摸索之后，终于摸清了“FCKeditor”上传漏洞的利用方法，步骤是： 1.不用注册用户，直接用IE打开网址：“http://127.0.0.1/nb2/editor/fck_editor/editor/filemanager/browser/default/browser.html?Type=Image&Connector=connectors/asp/connector.asp”，/editor之前是NB文章系统的网址。 2.将Image改为 ../ 后回车，跳转到NB文章系统的网站根目录下，就可以上传文件了，可直接上传至网站根目录中，也可以打开其中的一个文件夹后再上传。而漏洞形成的原因在于，只要将Type的提交值变化一下，就取消了上传文件格式限制，上传asp、asa、cer等格式文件随心所欲。 再看一下NB文章系统的更新历史，从EliteArticle 2.0 Beta 1版起增加对上传图片的管理，迄今已更新了四个版本，到最新的NBArticle_200_RC2版，都存在“FCKeditor”上传漏洞，就连NB文章系统的官方网站也没有幸免。在写稿之前，已发邮件通知NB管理员，希望能尽快修补此漏洞。 三、再测“FCKeditor”最新版 今天在整理NB文章系统的这个上传漏洞时，公正的讲，应该是“FCKeditor”的上传漏洞，NB属于用人不当嘛！呵呵！既然主要原因在“FCKeditor”上，那就再多了解一些它的信息。在百度中查找“FCKeditor”的资料时发现，其也有了最新版本，于是又下了一套FCKeditor v2.0 多国语言版，将其覆盖NB文章系统中的原版本，然后稍做修改，开始测试。 新版本果然有了改进，不仅功能增加了，而且还过滤了“..”，不能再把“FCKeditor”当浏览器用了！但这样做，“FCKeditor”就没有上传漏洞了？ 在“FCKeditor”中，程序会按管理员在源码中的设置建立一个文件夹，默认为"UserFiles"，用于存放用户创建的文位夹和上传的文件。而默认情况下，程序根据用户所选择上传模式的不同，自动打开所对应的文件夹，如上传图片，则自动打开UserFiles中的Image文件夹；上传Flash则打开Flash文件夹；上传文件就打开File文件夹。在某个上传模式内，用户所看到的只是程序所打开该模式内文件夹的内容，看不到其他其他文件夹中的内容。 了解了一些“FCKeditor”的文件夹设置后，下面就来小小的突破一下。在“FCKeditor”最新版本中，虽然不能使用“../”来浏览文件了，但它却无法对“/”和“\”加以限制，虽然在connector.asp中也对“/”和“\”做了一些处理，但仍可以利用“/”或“\”返回到上一级目录；如当前打开的是上传图片文件夹Image，只要将Type值Image改为/执行，就可以从Image文件夹内跳到UserFiles文件夹中了。 虽然不能浏览更多的文件，但这一跳转，却突破了上传格式的限制，也是上传文件的关键。最新版“FCKeditor”的上传步骤如下： 开启一个IE新窗口，输入网址:"http://127.0.0.1/nb2/editor/fck_editor/editor/filemanager/browser/default/browser.html?Type=Image&Connector=connectors/asp/connector.asp"执行， 然后将地址栏中Type的值Image改为/。

目录从Image跳转到Userfiles中了，(其实Type还有一个好玩的缺陷，就是将Type值Image改为什么就创建一个什么名字的文件夹)。现在目录已发生了变化，突破了上传限制，在当前userfiles文件夹内或其下级的任一文件夹内，包括Image文件夹内，都可以上传任意格式的文件了。“FCKeditor”确实是一款不错的在线编辑器，它不仅提供Asp版本，还提供了php、asp.net、perl等环境内运行的版本，因为环境原因，我只测试了Asp版本的，不知道其他环境下的版本是否也存在这样的漏洞，还是留给大家去测试吧!
